{"ast":null,"code":"import _createForOfIteratorHelper from\"/home/itsdcsec/falconws/falcon_face/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _regeneratorRuntime from\"/home/itsdcsec/falconws/falcon_face/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _objectSpread from\"/home/itsdcsec/falconws/falcon_face/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _asyncToGenerator from\"/home/itsdcsec/falconws/falcon_face/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/itsdcsec/falconws/falcon_face/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";/**\n@author Raja Reddy\nOctober 2021\n*/import{useState,useEffect,useMemo}from\"react\";import{withRouter}from\"react-router-dom\";import debounce from\"lodash\";import{useForm}from\"react-hook-form\";import axios from\"axios\";import*as yup from\"yup\";import useDebouncedSearch from\"../utils/useDebouncedSearch\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var schema=yup.object({fkDisplay:yup.string().required(\"Required\")//age: yup.number().positive().integer().required(),\n}).required();function LiveSearch(_ref){var parentData=_ref.parentData,parentCallback=_ref.parentCallback,fkEntity=_ref.fkEntity,errCallback=_ref.errCallback,readOnly=_ref.readOnly;//console.log(parentData.title);\n//console.log(parentCallback);\n//console.log(fkEntity);\n//const { register, handleSubmit, reset, setValue, getValues, formState: { errors } } = useForm({});\nvar _useForm=useForm({}),register=_useForm.register,setValue=_useForm.setValue,errors=_useForm.formState.errors;var initialState={search:\"\",list:\"\",showList:false};//Trying to set filters. Not working.\nvar filterStr=\"\";//console.log(sessionStorage.getItem('filters'));\nvar _useState=useState(initialState),_useState2=_slicedToArray(_useState,2),state=_useState2[0],setState=_useState2[1];var useSearch=function useSearch(){return useDebouncedSearch(function(query){return searchAsync(query);});};var _useSearch=useSearch(),inputText=_useSearch.inputText,setInputText=_useSearch.setInputText,searchResults=_useSearch.searchResults;//const searchAsync = async function(query) {\nvar searchAsync=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(query){var fetching,fetchData,_fetchData;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:console.log(query);if(parentData.preload){_context2.next=9;break;}_fetchData=function _fetchData3(){_fetchData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _filterStr,filters,url;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(fetching){_context.next=9;break;}_filterStr=\"\";if(sessionStorage.getItem(\"filters\")){filters=JSON.parse(sessionStorage.getItem(\"filters\"));filters&&filters.map(function(item){return _filterStr+=item+\",\";});if(_filterStr)_filterStr=_filterStr.substring(0,_filterStr.length-1);console.log(_filterStr);}url=\"/\".concat(parentData.url,\"?search=\").concat(query);if(parentData.field)url+=\"&field=\".concat(parentData.field);if(_filterStr)url+=\"&filters=\".concat(_filterStr);console.log(url);_context.next=9;return axios.get(url//{params: {filters: filters}}\n).then(function(response){//console.log(query);\n//console.log(filters);\n//console.log(response.data);\nsetState(function(prevState){return _objectSpread(_objectSpread({},prevState),{},{search:query,showList:true,list:response.data});});}).catch(function(error){if(error.response)errCallback(error.response.data.error);else errCallback(error.Error);});case 9:case\"end\":return _context.stop();}}},_callee);}));return _fetchData.apply(this,arguments);};fetchData=function _fetchData2(){return _fetchData.apply(this,arguments);};fetching=false;//async function fetchData(filters) {\nfetchData();return _context2.abrupt(\"return\",function(){fetching=true;});case 9:// Data already prefetched. Just show the drop down list. XXXXXX Not being used\nconsole.log(state.list);setState(function(prevState){return _objectSpread(_objectSpread({},prevState),{},{search:query,showList:true});});case 11:case\"end\":return _context2.stop();}}},_callee2);}));return function searchAsync(_x){return _ref2.apply(this,arguments);};}();useEffect(function(){if(fkEntity){var row=\"\";var _iterator=_createForOfIteratorHelper(parentData.searchList),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var field=_step.value;row+=fkEntity[field]+\" : \";}}catch(err){_iterator.e(err);}finally{_iterator.f();}row=row.substring(0,row.length-3);// Strip the last :\n//console.log(row);\nsetValue(\"fkDisplay\",row);setState(function(prevState){return _objectSpread(_objectSpread({},prevState),{},{search:row});});}//}, [fkEntity, setValue]);\n},[fkEntity]);var sendDataToParent=function sendDataToParent(foreignKeyEntity){parentCallback(foreignKeyEntity);};var setValueHandler=function setValueHandler(item){var row=\"\";var _iterator2=_createForOfIteratorHelper(parentData.searchList),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var field=_step2.value;row+=item[field]+\" : \";}//Strip the last ' : '\n}catch(err){_iterator2.e(err);}finally{_iterator2.f();}row=row.substring(0,row.length-3);//row += item.id;\nconsole.log(row);setState(function(prev){return _objectSpread(_objectSpread({},prev),{},{search:row,showList:false});});setValue(\"fkDisplay\",row);//let dataToParent = { props: { entity: item } };\nvar dataToParent={fk:parentData.fkEntity,entity:item};console.log(\"ValueHandler\");console.log(dataToParent);sendDataToParent(dataToParent);};var dropDownList=function dropDownList(item){var dropDownRow=function dropDownRow(item){var row=\"\";var _iterator3=_createForOfIteratorHelper(parentData.searchList),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var field=_step3.value;row+=item[field]+\" : \";}//console.log(row);\n//Strip the last ':'\n}catch(err){_iterator3.e(err);}finally{_iterator3.f();}row=row.substring(0,row.length-3);return/*#__PURE__*/_jsx(\"div\",{className:\"ml-4\",children:row});};return/*#__PURE__*/_jsx(\"li\",{onClick:function onClick(){return setValueHandler(item);},className:\"border rounded bg-green-500 hover:bg-green-700 text-white font-bold\",children:dropDownRow(item)},item.id);};var sorter=function sorter(a,b){//return a.name.toLowerCase().localeCompare(b.name.toLowerCase());\nvar aRow=\"\";var bRow=\"\";var _iterator4=_createForOfIteratorHelper(parentData.searchList),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var field=_step4.value;aRow+=a[field];bRow+=b[field];}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}return aRow.toLowerCase().localeCompare(bRow.toLowerCase());};var multiFieldFilter=function multiFieldFilter(item){var compositeField=\"\";var _iterator5=_createForOfIteratorHelper(parentData.searchList),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var field=_step5.value;compositeField+=item[field];}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}return compositeField.toLowerCase().indexOf(state.search.toLowerCase())>=0;};var makeResult=function makeResult(list){if(!list)return/*#__PURE__*/_jsx(\"li\",{children:\"No results!\"});var newList=list.filter(multiFieldFilter);if(newList.length)return newList.slice(0,7)//Get only 7 items\n.sort(function(a,b){return sorter(a,b);})//Sort alphabetically\n.map(dropDownList);return/*#__PURE__*/_jsx(\"li\",{children:\"No results!\"});};var handleFocus=function handleFocus(event){return event.target.select();};return/*#__PURE__*/_jsxs(\"div\",{className:\"-px-2 -mx-2\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[parentData&&parentData.title,\" :\",\" \",fkEntity?fkEntity[parentData.searchList[0]]:\"\"]}),/*#__PURE__*/_jsx(\"input\",_objectSpread(_objectSpread({type:\"text\",name:\"fkDisplay\"},register(\"fkDisplay\")),{},{placeholder:\"Search\",onChange:function onChange(e){return setInputText(e.target.value);},onFocus:handleFocus,className:\"form-control py-0 max-w-xs\",readOnly:readOnly})),state.showList,state.search!==\"\"&&state.showList?/*#__PURE__*/_jsx(\"ul\",{children:makeResult(state.list)}):state.showList&&/*#__PURE__*/_jsxs(\"span\",{children:[/*#__PURE__*/_jsx(\"br\",{}),\" \"]})]});}export default withRouter(LiveSearch);","map":{"version":3,"sources":["/home/itsdcsec/falconws/falcon_face/src/utils/LiveSearch.js"],"names":["useState","useEffect","useMemo","withRouter","debounce","useForm","axios","yup","useDebouncedSearch","schema","object","fkDisplay","string","required","LiveSearch","parentData","parentCallback","fkEntity","errCallback","readOnly","register","setValue","errors","formState","initialState","search","list","showList","filterStr","state","setState","useSearch","query","searchAsync","inputText","setInputText","searchResults","fetchData","console","log","preload","fetching","sessionStorage","getItem","filters","JSON","parse","map","item","substring","length","url","field","get","then","response","prevState","data","catch","error","Error","row","searchList","sendDataToParent","foreignKeyEntity","setValueHandler","prev","dataToParent","fk","entity","dropDownList","dropDownRow","id","sorter","a","b","aRow","bRow","toLowerCase","localeCompare","multiFieldFilter","compositeField","indexOf","makeResult","newList","filter","slice","sort","handleFocus","event","target","select","title","e","value"],"mappings":"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","sourcesContent":["/**\n@author Raja Reddy\nOctober 2021\n*/\n\nimport { useState, useEffect, useMemo } from \"react\";\nimport { withRouter } from \"react-router-dom\";\nimport debounce from \"lodash\";\n\nimport { useForm } from \"react-hook-form\";\nimport axios from \"axios\";\nimport * as yup from \"yup\";\nimport useDebouncedSearch from \"../utils/useDebouncedSearch\";\n\nconst schema = yup\n  .object({\n    fkDisplay: yup.string().required(\"Required\"),\n    //age: yup.number().positive().integer().required(),\n  })\n  .required();\n\nfunction LiveSearch({\n  parentData,\n  parentCallback,\n  fkEntity,\n  errCallback,\n  readOnly,\n}) {\n  //console.log(parentData.title);\n\n  //console.log(parentCallback);\n  //console.log(fkEntity);\n  //const { register, handleSubmit, reset, setValue, getValues, formState: { errors } } = useForm({});\n  const {\n    register,\n    setValue,\n    formState: { errors },\n  } = useForm({});\n\n  const initialState = {\n    search: \"\",\n    list: \"\",\n    showList: false,\n  };\n\n  //Trying to set filters. Not working.\n  let filterStr = \"\";\n  //console.log(sessionStorage.getItem('filters'));\n\n  const [state, setState] = useState(initialState);\n  const useSearch = () => useDebouncedSearch((query) => searchAsync(query));\n  const { inputText, setInputText, searchResults } = useSearch();\n\n  //const searchAsync = async function(query) {\n  const searchAsync = async (query) => {\n    console.log(query);\n\n    if (!parentData.preload) {\n      let fetching = false;\n      //async function fetchData(filters) {\n      async function fetchData() {\n        if (!fetching) {\n          let filterStr = \"\";\n          if (sessionStorage.getItem(\"filters\")) {\n            let filters = JSON.parse(sessionStorage.getItem(\"filters\"));\n            filters && filters.map((item) => (filterStr += item + \",\"));\n            if (filterStr)\n              filterStr = filterStr.substring(0, filterStr.length - 1);\n            console.log(filterStr);\n          }\n          let url = `/${parentData.url}?search=${query}`;\n          if (parentData.field) url += `&field=${parentData.field}`;\n          if (filterStr) url += `&filters=${filterStr}`;\n          console.log(url);\n          await axios\n            .get(\n              url\n              //{params: {filters: filters}}\n            )\n            .then((response) => {\n              //console.log(query);\n              //console.log(filters);\n              //console.log(response.data);\n              setState((prevState) => ({\n                ...prevState,\n                search: query,\n                showList: true,\n                list: response.data,\n              }));\n            })\n            .catch((error) => {\n              if (error.response) errCallback(error.response.data.error);\n              else errCallback(error.Error);\n            });\n        }\n      }\n\n      fetchData();\n      return () => {\n        fetching = true;\n      };\n    } else {\n      // Data already prefetched. Just show the drop down list. XXXXXX Not being used\n      console.log(state.list);\n      setState((prevState) => ({\n        ...prevState,\n        search: query,\n        showList: true,\n      }));\n    }\n  };\n\n  useEffect(() => {\n    if (fkEntity) {\n      let row = \"\";\n\n      for (let field of parentData.searchList) {\n        row += fkEntity[field] + \" : \";\n      }\n\n      row = row.substring(0, row.length - 3); // Strip the last :\n      //console.log(row);\n      setValue(\"fkDisplay\", row);\n      setState((prevState) => ({\n        ...prevState,\n        search: row,\n      }));\n    }\n\n    //}, [fkEntity, setValue]);\n  }, [fkEntity]);\n\n  const sendDataToParent = (foreignKeyEntity) => {\n    parentCallback(foreignKeyEntity);\n  };\n\n  const setValueHandler = (item) => {\n    let row = \"\";\n    for (let field of parentData.searchList) {\n      row += item[field] + \" : \";\n    }\n    //Strip the last ' : '\n    row = row.substring(0, row.length - 3);\n    //row += item.id;\n    console.log(row);\n    setState((prev) => ({\n      ...prev,\n      search: row,\n      showList: false,\n    }));\n    setValue(\"fkDisplay\", row);\n    //let dataToParent = { props: { entity: item } };\n    let dataToParent = { fk: parentData.fkEntity, entity: item };\n\n    console.log(\"ValueHandler\");\n    console.log(dataToParent);\n    sendDataToParent(dataToParent);\n  };\n\n  const dropDownList = (item) => {\n    const dropDownRow = (item) => {\n      let row = \"\";\n      for (let field of parentData.searchList) {\n        row += item[field] + \" : \";\n      }\n      //console.log(row);\n      //Strip the last ':'\n      row = row.substring(0, row.length - 3);\n      return <div className=\"ml-4\">{row}</div>;\n    };\n\n    return (\n      <li\n        key={item.id}\n        onClick={() => setValueHandler(item)}\n        className=\"border rounded bg-green-500 hover:bg-green-700 text-white font-bold\"\n      >\n        {dropDownRow(item)}\n      </li>\n    );\n  };\n\n  const sorter = (a, b) => {\n    //return a.name.toLowerCase().localeCompare(b.name.toLowerCase());\n    let aRow = \"\";\n    let bRow = \"\";\n    for (let field of parentData.searchList) {\n      aRow += a[field];\n      bRow += b[field];\n    }\n    return aRow.toLowerCase().localeCompare(bRow.toLowerCase());\n  };\n\n  const multiFieldFilter = (item) => {\n    let compositeField = \"\";\n    for (let field of parentData.searchList) {\n      compositeField += item[field];\n    }\n    return (\n      compositeField.toLowerCase().indexOf(state.search.toLowerCase()) >= 0\n    );\n  };\n\n  const makeResult = (list) => {\n    if (!list) return <li>No results!</li>;\n    const newList = list.filter(multiFieldFilter);\n    if (newList.length)\n      return newList\n        .slice(0, 7) //Get only 7 items\n        .sort((a, b) => sorter(a, b)) //Sort alphabetically\n        .map(dropDownList);\n    return <li>No results!</li>;\n  };\n\n  const handleFocus = (event) => event.target.select();\n\n  return (\n    <div className=\"-px-2 -mx-2\">\n      <label>\n        {parentData && parentData.title} :{\" \"}\n        {fkEntity ? fkEntity[parentData.searchList[0]] : \"\"}\n      </label>\n\n      <input\n        type=\"text\"\n        name=\"fkDisplay\"\n        {...register(\"fkDisplay\")}\n        placeholder=\"Search\"\n        onChange={(e) => setInputText(e.target.value)}\n        onFocus={handleFocus}\n        className=\"form-control py-0 max-w-xs\"\n        readOnly={readOnly}\n      />\n\n      {state.showList}\n      {state.search !== \"\" && state.showList ? (\n        <ul>{makeResult(state.list)}</ul>\n      ) : (\n        state.showList && (\n          <span>\n            <br />{\" \"}\n          </span>\n        )\n      )}\n    </div>\n  );\n}\n\nexport default withRouter(LiveSearch);\n"]},"metadata":{},"sourceType":"module"}
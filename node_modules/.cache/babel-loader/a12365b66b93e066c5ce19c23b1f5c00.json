{"ast":null,"code":"var _jsxFileName = \"/home/itsdc13/Softwares/Latest/tulip-face/src/utils/LiveSearch.js\";\n\n/**\n@author Raja Reddy\nOctober 2021\n*/\nimport { useState, useEffect, useMemo } from \"react\";\nimport { withRouter } from \"react-router-dom\";\nimport debounce from \"lodash\";\nimport { useForm } from \"react-hook-form\";\nimport axios from \"axios\";\nimport * as yup from \"yup\";\nimport useDebouncedSearch from \"../utils/useDebouncedSearch\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst schema = yup.object({\n  fkDisplay: yup.string().required(\"Required\") //age: yup.number().positive().integer().required(),\n\n}).required();\n\nfunction LiveSearch({\n  parentData,\n  parentCallback,\n  fkEntity,\n  errCallback,\n  readOnly\n}) {\n  //console.log(parentData.title);\n  //console.log(parentCallback);\n  //console.log(fkEntity);\n  //const { register, handleSubmit, reset, setValue, getValues, formState: { errors } } = useForm({});\n  const {\n    register,\n    setValue,\n    formState: {\n      errors\n    }\n  } = useForm({});\n  const initialState = {\n    search: \"\",\n    list: \"\",\n    showList: false\n  }; //Trying to set filters. Not working.\n\n  let filterStr = \"\"; //console.log(sessionStorage.getItem('filters'));\n\n  const [state, setState] = useState(initialState);\n\n  const useSearch = () => useDebouncedSearch(query => searchAsync(query));\n\n  const {\n    inputText,\n    setInputText,\n    searchResults\n  } = useSearch(); //const searchAsync = async function(query) {\n\n  const searchAsync = async query => {\n    console.log(query);\n\n    if (!parentData.preload) {\n      let fetching = false; //async function fetchData(filters) {\n\n      async function fetchData() {\n        if (!fetching) {\n          let filterStr = \"\";\n\n          if (sessionStorage.getItem(\"filters\")) {\n            let filters = JSON.parse(sessionStorage.getItem(\"filters\"));\n            filters && filters.map(item => filterStr += item + \",\");\n            if (filterStr) filterStr = filterStr.substring(0, filterStr.length - 1);\n            console.log(filterStr);\n          }\n\n          let url = `/${parentData.url}?search=${query}`;\n          if (parentData.field) url += `&field=${parentData.field}`;\n          if (filterStr) url += `&filters=${filterStr}`;\n          console.log(\"url is:\" + url);\n          await axios.get(url //{params: {filters: filters}}\n          ).then(response => {\n            //console.log(query);\n            //console.log(filters);\n            //console.log(response.data);\n            setState(prevState => ({ ...prevState,\n              search: query,\n              showList: true,\n              list: response.data\n            }));\n          }).catch(error => {\n            if (error.response) errCallback(error.response.data.error);else errCallback(error.Error);\n          });\n        }\n      }\n\n      fetchData();\n      return () => {\n        fetching = true;\n      };\n    } else {\n      // Data already prefetched. Just show the drop down list. XXXXXX Not being used\n      console.log(state.list);\n      setState(prevState => ({ ...prevState,\n        search: query,\n        showList: true\n      }));\n    }\n  };\n\n  useEffect(() => {\n    if (fkEntity) {\n      let row = \"\";\n\n      for (let field of parentData.searchList) {\n        row += fkEntity[field] + \" : \";\n      }\n\n      row = row.substring(0, row.length - 3); // Strip the last :\n      //console.log(row);\n\n      setValue(\"fkDisplay\", row);\n      setState(prevState => ({ ...prevState,\n        search: row\n      }));\n    } //}, [fkEntity, setValue]);\n\n  }, [fkEntity]);\n\n  const sendDataToParent = foreignKeyEntity => {\n    parentCallback(foreignKeyEntity);\n  };\n\n  const setValueHandler = item => {\n    let row = \"\";\n\n    for (let field of parentData.searchList) {\n      row += item[field] + \" : \";\n    } //Strip the last ' : '\n\n\n    row = row.substring(0, row.length - 3); //row += item.id;\n\n    console.log(row);\n    setState(prev => ({ ...prev,\n      search: row,\n      showList: false\n    }));\n    setValue(\"fkDisplay\", row); //let dataToParent = { props: { entity: item } };\n\n    let dataToParent = {\n      fk: parentData.fkEntity,\n      entity: item\n    };\n    console.log(\"ValueHandler\");\n    console.log(dataToParent);\n    sendDataToParent(dataToParent);\n  };\n\n  const dropDownList = item => {\n    const dropDownRow = item => {\n      let row = \"\";\n\n      for (let field of parentData.searchList) {\n        row += item[field] + \" : \";\n      } //console.log(row);\n      //Strip the last ':'\n\n\n      row = row.substring(0, row.length - 3);\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"ml-4\",\n        children: row\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 169,\n        columnNumber: 14\n      }, this);\n    };\n\n    return /*#__PURE__*/_jsxDEV(\"li\", {\n      onClick: () => setValueHandler(item),\n      className: \"border rounded bg-green-500 hover:bg-green-700 text-white font-bold\",\n      children: dropDownRow(item)\n    }, item.id, false, {\n      fileName: _jsxFileName,\n      lineNumber: 173,\n      columnNumber: 7\n    }, this);\n  };\n\n  const sorter = (a, b) => {\n    //return a.name.toLowerCase().localeCompare(b.name.toLowerCase());\n    let aRow = \"\";\n    let bRow = \"\";\n\n    for (let field of parentData.searchList) {\n      aRow += a[field];\n      bRow += b[field];\n    }\n\n    return aRow.toLowerCase().localeCompare(bRow.toLowerCase());\n  };\n\n  const multiFieldFilter = item => {\n    let compositeField = \"\";\n\n    for (let field of parentData.searchList) {\n      compositeField += item[field];\n    }\n\n    return compositeField.toLowerCase().indexOf(state.search.toLowerCase()) >= 0;\n  };\n\n  const makeResult = list => {\n    if (!list) return /*#__PURE__*/_jsxDEV(\"li\", {\n      children: \"No results!\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 205,\n      columnNumber: 23\n    }, this);\n    const newList = list.filter(multiFieldFilter);\n    if (newList.length) return newList.slice(0, 7) //Get only 7 items\n    .sort((a, b) => sorter(a, b)) //Sort alphabetically\n    .map(dropDownList);\n    return /*#__PURE__*/_jsxDEV(\"li\", {\n      children: \"No results!\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 212,\n      columnNumber: 12\n    }, this);\n  };\n\n  const handleFocus = event => event.target.select();\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"-px-2 -mx-2\",\n    children: [/*#__PURE__*/_jsxDEV(\"label\", {\n      children: [parentData && parentData.title, \" :\", \" \", fkEntity ? fkEntity[parentData.searchList[0]] : \"\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 219,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n      type: \"text\",\n      name: \"fkDisplay\",\n      ...register(\"fkDisplay\"),\n      placeholder: \"Search\",\n      onChange: e => setInputText(e.target.value),\n      onFocus: handleFocus,\n      className: \"form-control py-0\",\n      readOnly: readOnly\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 224,\n      columnNumber: 7\n    }, this), state.showList, state.search !== \"\" && state.showList ? /*#__PURE__*/_jsxDEV(\"ul\", {\n      children: makeResult(state.list)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 237,\n      columnNumber: 9\n    }, this) : state.showList && /*#__PURE__*/_jsxDEV(\"span\", {\n      children: [/*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 241,\n        columnNumber: 13\n      }, this), \" \"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 240,\n      columnNumber: 11\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 218,\n    columnNumber: 5\n  }, this);\n}\n\nexport default withRouter(LiveSearch);","map":{"version":3,"sources":["/home/itsdc13/Softwares/Latest/tulip-face/src/utils/LiveSearch.js"],"names":["useState","useEffect","useMemo","withRouter","debounce","useForm","axios","yup","useDebouncedSearch","schema","object","fkDisplay","string","required","LiveSearch","parentData","parentCallback","fkEntity","errCallback","readOnly","register","setValue","formState","errors","initialState","search","list","showList","filterStr","state","setState","useSearch","query","searchAsync","inputText","setInputText","searchResults","console","log","preload","fetching","fetchData","sessionStorage","getItem","filters","JSON","parse","map","item","substring","length","url","field","get","then","response","prevState","data","catch","error","Error","row","searchList","sendDataToParent","foreignKeyEntity","setValueHandler","prev","dataToParent","fk","entity","dropDownList","dropDownRow","id","sorter","a","b","aRow","bRow","toLowerCase","localeCompare","multiFieldFilter","compositeField","indexOf","makeResult","newList","filter","slice","sort","handleFocus","event","target","select","title","e","value"],"mappings":"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","sourcesContent":["/**\n@author Raja Reddy\nOctober 2021\n*/\n\nimport { useState, useEffect, useMemo } from \"react\";\nimport { withRouter } from \"react-router-dom\";\nimport debounce from \"lodash\";\n\nimport { useForm } from \"react-hook-form\";\nimport axios from \"axios\";\nimport * as yup from \"yup\";\nimport useDebouncedSearch from \"../utils/useDebouncedSearch\";\n\nconst schema = yup\n  .object({\n    fkDisplay: yup.string().required(\"Required\"),\n    //age: yup.number().positive().integer().required(),\n  })\n  .required();\n\nfunction LiveSearch({\n  parentData,\n  parentCallback,\n  fkEntity,\n  errCallback,\n  readOnly,\n}) {\n  //console.log(parentData.title);\n\n  //console.log(parentCallback);\n  //console.log(fkEntity);\n  //const { register, handleSubmit, reset, setValue, getValues, formState: { errors } } = useForm({});\n  const {\n    register,\n    setValue,\n    formState: { errors },\n  } = useForm({});\n\n  const initialState = {\n    search: \"\",\n    list: \"\",\n    showList: false,\n  };\n\n  //Trying to set filters. Not working.\n  let filterStr = \"\";\n  //console.log(sessionStorage.getItem('filters'));\n\n  const [state, setState] = useState(initialState);\n  const useSearch = () => useDebouncedSearch((query) => searchAsync(query));\n  const { inputText, setInputText, searchResults } = useSearch();\n\n  //const searchAsync = async function(query) {\n  const searchAsync = async (query) => {\n    console.log(query);\n\n    if (!parentData.preload) {\n      let fetching = false;\n      //async function fetchData(filters) {\n      async function fetchData() {\n        if (!fetching) {\n          let filterStr = \"\";\n          if (sessionStorage.getItem(\"filters\")) {\n            let filters = JSON.parse(sessionStorage.getItem(\"filters\"));\n            filters && filters.map((item) => (filterStr += item + \",\"));\n            if (filterStr)\n              filterStr = filterStr.substring(0, filterStr.length - 1);\n            console.log(filterStr);\n          }\n          let url = `/${parentData.url}?search=${query}`;\n          if (parentData.field) url += `&field=${parentData.field}`;\n          if (filterStr) url += `&filters=${filterStr}`;\n          console.log(\"url is:\" + url);\n          await axios\n            .get(\n              url\n              //{params: {filters: filters}}\n            )\n            .then((response) => {\n              //console.log(query);\n              //console.log(filters);\n              //console.log(response.data);\n              setState((prevState) => ({\n                ...prevState,\n                search: query,\n                showList: true,\n                list: response.data,\n              }));\n            })\n            .catch((error) => {\n              if (error.response) errCallback(error.response.data.error);\n              else errCallback(error.Error);\n            });\n        }\n      }\n\n      fetchData();\n      return () => {\n        fetching = true;\n      };\n    } else {\n      // Data already prefetched. Just show the drop down list. XXXXXX Not being used\n      console.log(state.list);\n      setState((prevState) => ({\n        ...prevState,\n        search: query,\n        showList: true,\n      }));\n    }\n  };\n\n  useEffect(() => {\n    if (fkEntity) {\n      let row = \"\";\n\n      for (let field of parentData.searchList) {\n        row += fkEntity[field] + \" : \";\n      }\n\n      row = row.substring(0, row.length - 3); // Strip the last :\n      //console.log(row);\n      setValue(\"fkDisplay\", row);\n      setState((prevState) => ({\n        ...prevState,\n        search: row,\n      }));\n    }\n\n    //}, [fkEntity, setValue]);\n  }, [fkEntity]);\n\n  const sendDataToParent = (foreignKeyEntity) => {\n    parentCallback(foreignKeyEntity);\n  };\n\n  const setValueHandler = (item) => {\n    let row = \"\";\n    for (let field of parentData.searchList) {\n      row += item[field] + \" : \";\n    }\n    //Strip the last ' : '\n    row = row.substring(0, row.length - 3);\n    //row += item.id;\n    console.log(row);\n    setState((prev) => ({\n      ...prev,\n      search: row,\n      showList: false,\n    }));\n    setValue(\"fkDisplay\", row);\n    //let dataToParent = { props: { entity: item } };\n    let dataToParent = { fk: parentData.fkEntity, entity: item };\n\n    console.log(\"ValueHandler\");\n    console.log(dataToParent);\n    sendDataToParent(dataToParent);\n  };\n\n  const dropDownList = (item) => {\n    const dropDownRow = (item) => {\n      let row = \"\";\n      for (let field of parentData.searchList) {\n        row += item[field] + \" : \";\n      }\n      //console.log(row);\n      //Strip the last ':'\n      row = row.substring(0, row.length - 3);\n      return <div className=\"ml-4\">{row}</div>;\n    };\n\n    return (\n      <li\n        key={item.id}\n        onClick={() => setValueHandler(item)}\n        className=\"border rounded bg-green-500 hover:bg-green-700 text-white font-bold\"\n      >\n        {dropDownRow(item)}\n      </li>\n    );\n  };\n\n  const sorter = (a, b) => {\n    //return a.name.toLowerCase().localeCompare(b.name.toLowerCase());\n    let aRow = \"\";\n    let bRow = \"\";\n    for (let field of parentData.searchList) {\n      aRow += a[field];\n      bRow += b[field];\n    }\n    return aRow.toLowerCase().localeCompare(bRow.toLowerCase());\n  };\n\n  const multiFieldFilter = (item) => {\n    let compositeField = \"\";\n    for (let field of parentData.searchList) {\n      compositeField += item[field];\n    }\n    return (\n      compositeField.toLowerCase().indexOf(state.search.toLowerCase()) >= 0\n    );\n  };\n\n  const makeResult = (list) => {\n    if (!list) return <li>No results!</li>;\n    const newList = list.filter(multiFieldFilter);\n    if (newList.length)\n      return newList\n        .slice(0, 7) //Get only 7 items\n        .sort((a, b) => sorter(a, b)) //Sort alphabetically\n        .map(dropDownList);\n    return <li>No results!</li>;\n  };\n\n  const handleFocus = (event) => event.target.select();\n\n  return (\n    <div className=\"-px-2 -mx-2\">\n      <label>\n        {parentData && parentData.title} :{\" \"}\n        {fkEntity ? fkEntity[parentData.searchList[0]] : \"\"}\n      </label>\n\n      <input\n        type=\"text\"\n        name=\"fkDisplay\"\n        {...register(\"fkDisplay\")}\n        placeholder=\"Search\"\n        onChange={(e) => setInputText(e.target.value)}\n        onFocus={handleFocus}\n        className=\"form-control py-0\"\n        readOnly={readOnly}\n      />\n\n      {state.showList}\n      {state.search !== \"\" && state.showList ? (\n        <ul>{makeResult(state.list)}</ul>\n      ) : (\n        state.showList && (\n          <span>\n            <br />{\" \"}\n          </span>\n        )\n      )}\n    </div>\n  );\n}\n\nexport default withRouter(LiveSearch);\n"]},"metadata":{},"sourceType":"module"}